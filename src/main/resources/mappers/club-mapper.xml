<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="clubMapper">

<!-- 담당자  : 황서연
수정일자 : 2021.11.07
수정사항 : detail페이지 중
수정필요사항 : 메인페이지에서 마감임박리스트 조회시 collecton으로 select하기 -->

  <resultMap id="clubResultSet" type="Club">
		<id column="CLUB_NO" property="clubNo"/>
		<result column="REF_PLACE_NO" property="placeNo"/>
		<result column="USER_ID" property="userId"/>
		<result column="CLUB_TITLE" property="clubTitle"/>
		<result column="INTRO" property="intro"/>
		<result column="ACTIVITY" property="activity"/>
		<result column="WANT" property="want"/>
		<result column="NOTWANT" property="notwant"/>
		<result column="TIMES" property="times"/>
		<result column="ONOFF_LINE" property="onoffLine"/>
		<result column="CLUB_CAPACITY" property="clubCapacity"/>
		<result column="CSTART_DATE" property="clubStartDate"/>
		<result column="CEND_DATE" property="clubEndDate"/>
		<result column="BK_NAME" property="bkName"/>
		<result column="BK_WRITER" property="bkWriter"/>
		<result column="BK_PUBLISHER" property="bkPublisher"/>
		<result column="CREATE_DATE" property="createDate"/>
		<result column="CONDITION" property="condition"/>
		<result column="STATUS" property="status"/>
		<result column="HOST_COMMENT" property="hostComment"/>
		<result column="HOST_NAME" property="hostName"/>
		<result column="HSTART_DATE" property="hstartDate"/>
		<result column="HEND_DATE" property="hendDate"/>
		<result column="HWHAT_TODO" property="hwhatTodo"/>
		<result column="CATEGORY" property="category"/>
		
		<!-- detailClub용(11.07) -->
		<!-- 속성들 1)property:필드명  2)ofType:필드의클래스위치   -->
		<collection property="clubTimes" ofType="com.kh.bookmate.club.model.vo.ClubTime">
			<id column="CLUB_TIME_NO" property="timeNo" jdbcType="INTEGER" />
			<result column="REF_CLUB_NO" property="clubNo" jdbcType="INTEGER" />  <!-- 되려나 -->
			<result column="CLUB_DATE" property="clubDate" jdbcType="DATE" />
			<result column="START_TIME" property="startTime" jdbcType="VARCHAR" />
			<result column="END_TIME" property="endTime" jdbcType="VARCHAR" />
			<result column="APPLY_COUNT" property="apply_count" jdbcType="INTEGER" />
		</collection>
		
		<collection property="clubAttachments" ofType="com.kh.bookmate.club.model.vo.ClubAttachment">
			<!-- <id column="FILE_NO" property="fileNo" jdbcType="INTEGER" /> 
			https://stackoverflow.com/questions/51080884/how-to-use-multiple-collection-in-mybatis-resultmap
			이 객체가 time의 갯수에따라 여러 개 생성되어서 참고해서 고치니 해결됐다.-->
			<result column="REF_CLUB_NO" property="clubNo" jdbcType="INTEGER" />  <!-- 되려나 -->
			<result column="ORIGINAL_NAME" property="originalName" jdbcType="DATE" />
			<result column="CHANGE_NAME" property="changeName" jdbcType="VARCHAR" />
			<result column="FILE_TYPE" property="fileType" jdbcType="VARCHAR" />
		</collection>
	</resultMap>

	
	<resultMap id="clubAttachmentResultSet" type="ClubAttachment">
		<id column="FILE_NO" property="fileNo"/>
		<result column="REF_CLUB_NO" property="clubNo"/>
		<result column="ORIGINAL_NAME" property="originalName"/>
		<result column="CHANGE_NAME" property="changeName"/>
		<result column="FILE_TYPE" property="fileType"/>
	</resultMap>

	<resultMap id="clubTimeResultSet" type="ClubTime">
		<id column="CLUB_TIME_NO" property="timeNo"/>
		<result column="REF_CLUB_NO" property="clubNo"/>
		<result column="CLUB_DATE" property="clubDate"/>
		<result column="START_TIME" property="startTime"/>
		<result column="END_TIME" property="endTime"/>
		<result column="STATUS" property="status"/>
		<result column="APPLY_COUNT" property="apply_count"></result>
	</resultMap>


	<select id="checkHost" resultType="_int">
		SELECT COUNT(*)
		FROM CLUB
		WHERE HOST_NAME = #{hostName}
	</select>
	
	<!-- insert 후 key 값 가져온다. 1단계 저장 후 바로 2단계에 같은 clubNo로 저장해야 하기 때문-->
	<insert id="saveStep1_1" parameterType="Club">
		INSERT INTO
		CLUB(CLUB_NO, USER_ID, HOST_NAME, HOST_COMMENT, HSTART_DATE, HEND_DATE, HWHAT_TODO)
		VALUES(SEQ_CNO.NEXTVAL, #{userId}, #{hostName}, #{hostComment},#{hstartDate}, #{hendDate}, #{hwhatTodo})
		<selectKey keyProperty="clubNo" resultType="_int" order="AFTER">
			SELECT SEQ_CNO.CURRVAL FROM DUAL
		</selectKey>
	</insert>
	
	<insert id="saveStep1_2" parameterType="ClubAttachment">
		INSERT INTO CLUB_ATTACHMENT
		VALUES(SEQ_CANO.NEXTVAL, SEQ_CNO.CURRVAL, #{originalName}, #{changeName}, #{fileType})
	</insert>


	<update id="saveStep2_1" parameterType="Club">
		UPDATE CLUB
		SET CATEGORY=#{category}, CLUB_TITLE=#{clubTitle},
			INTRO=#{intro}, ACTIVITY=#{activity}, WANT=#{want}, NOTWANT=#{notwant},
			CLUB_CAPACITY=#{clubCapacity}
		WHERE CLUB_NO=#{clubNo} AND STATUS='Y'
	</update>
	
	<insert id="saveStep2_2" parameterType="ClubAttachment">
		INSERT INTO CLUB_ATTACHMENT
		VALUES(SEQ_CANO.NEXTVAL, #{clubNo}, #{originalName}, #{changeName}, #{fileType})
	</insert>
	
	
	<update id="saveStep3_1" parameterType="Club">
		UPDATE CLUB
		SET ONOFF_LINE=#{onoffLine}, TIMES=#{times},
			CSTART_DATE=#{clubStartDate}, CEND_DATE=#{clubEndDate}, 
			BK_NAME=#{bkName}, BK_WRITER=#{bkWriter}, BK_PUBLISHER=#{bkPublisher}
		WHERE CLUB_NO=#{clubNo} AND STATUS='Y'
	</update>

	<!-- foreach 시도3 : 성공! 
	     전달받는 값의 자료형에 따라서 foreach 다르게 써준다. 아래는 list를 받았을 경우이다-->
	<insert id="saveStep3_2" parameterType="java.util.Map">
		INSERT INTO CLUB_TIME(CLUB_TIME_NO,REF_CLUB_NO,CLUB_DATE,START_TIME,END_TIME)
		SELECT SEQ_CTNO.NEXTVAL, A.* 
		FROM(
			<foreach item="item" collection="list" separator="UNION ALL ">
				select 
				#{item.clubNo} as REF_CLUB_NO,
				#{item.clubDate} as CLUB_DATE,
				#{item.startTime} as START_TIME,
				#{item.endTime} as END_TIME
				from dual
			</foreach>) A
	</insert>
	
	<update id="insertClub" parameterType="Club">
		UPDATE CLUB
		SET ONOFF_LINE=#{onoffLine}, TIMES=#{times},
			CSTART_DATE=#{clubStartDate}, CEND_DATE=#{clubEndDate}, 
			BK_NAME=#{bkName}, BK_WRITER=#{bkWriter}, BK_PUBLISHER=#{bkPublisher},
			CONDITION=2
		WHERE CLUB_NO=#{clubNo} AND STATUS='Y'
	</update>
	
	<!-- 페이징처리 안됨,,, https://okky.kr/article/1091369(okky에 질문했지만 영양가있는 답은 없었다..) -->
	<!-- <select id="selectList3" resultMap="clubResultSet">
		SELECT HOST_NAME, CLUB_NO, CATEGORY, CLUB_TITLE, ONOFF_LINE, CLUB_CAPACITY, CONDITION, B.CLUB_TIME_NO, B.CLUB_DATE, B.START_TIME, B.END_TIME
		FROM CLUB A
		LEFT JOIN CLUB_TIME B
		ON A.CLUB_NO = B.REF_CLUB_NO
		WHERE USER_ID=#{userId} AND A.STATUS='Y'
		ORDER BY CLUB_NO DESC	
	</select> -->
	
	<!-- 마이페이지조회1 : club테이블 페이징조회 -->
	<select id="selectList_club" resultMap="clubResultSet">
		SELECT HOST_NAME, CLUB_NO, CATEGORY, CLUB_TITLE, ONOFF_LINE, CLUB_CAPACITY, CONDITION, CSTART_DATE
		FROM CLUB 
		WHERE USER_ID=#{userId} AND STATUS='Y'
		ORDER BY CLUB_NO DESC	
	</select>

	<!-- 마이페이지조회2 : club_time 테이블 위에서조회해온 clubNo로 조회-->
	<select id="selectList_clubTime" resultMap="clubTimeResultSet">
		SELECT REF_CLUB_NO, CLUB_DATE, START_TIME, END_TIME
		FROM CLUB_TIME
		WHERE REF_CLUB_NO IN
		<foreach item="item" collection="list" open="(" close=")" separator=",">
			#{item}
		</foreach>
		ORDER BY REF_CLUB_NO DESC	
	</select>
	
	
	
<!-- 독서모임개설관리(mypage3)-독서모임 삭제 -->
	<!--1.for 사진 삭제(프로젝트 upload_files에서)  -->
	<select id="selectPhotoList" resultMap="clubAttachmentResultSet">
		SELECT * FROM CLUB_ATTACHMENT
		WHERE REF_CLUB_NO IN
		<foreach item="item" collection="list" open="(" close=")" separator=",">
			#{item}
		</foreach>
	</select>

	<!-- 2.club에서 삭제 -->
	<delete id="deleteClub3" parameterType="_int">
		DELETE CLUB
		WHERE STATUS='Y' AND CLUB_NO IN 
		<foreach item="item" collection="list" open="(" close=")" separator=",">
			#{item}
		</foreach>
	</delete>
	
	<!-- listcount for 페이징처리용 -->
	<select id="selectListCount" resultType="_int">
		SELECT COUNT(*)
		FROM CLUB
		WHERE STATUS='Y'	
		AND USER_ID = #{userId}	
	</select>
	
	<!-- 메인페이지 - category클릭시 리스트 넘기기 -->
	<select id="selectCateList" resultMap="clubResultSet">
		<![CDATA[
		SELECT A.* , B.CHANGE_NAME 
		FROM CLUB A
		LEFT JOIN CLUB_ATTACHMENT B
		ON A.CLUB_NO = B.REF_CLUB_NO
		WHERE A.CONDITION=4 AND A.STATUS='Y'
		AND CSTART_DATE <= TO_CHAR(SYSDATE, 'YYYY-MM-DD')
		AND CEND_DATE > SYSDATE AND CATEGORY=#{category}
		AND B.FILE_TYPE=2
		]]>
	</select>
	
	<!-- 메인페이지 - 마감임박 리스트(1.Club테이블에서 조회) -->
	<select id="selectEndList" resultMap="clubResultSet">
		<![CDATA[
		SELECT *
		FROM(SELECT * 
		     FROM CLUB
		     WHERE STATUS='Y' AND 
		     CONDITION = 4 AND
		     CEND_DATE > SYSDATE AND 
     		 CSTART_DATE <= SYSDATE 
		     ORDER BY CEND_DATE)
		WHERE ROWNUM <= 9
		]]>
	</select>
	
	<!-- 메인페이지 - 마감임박 리스트(2. ClubAttachment테이블에서 조회) 
	     **이 부분은 페이징처리가 없으니 collection으로 해도 될 것 같은데?-->
	<select id="selectList_clubAttachment" resultMap="clubAttachmentResultSet">
		SELECT *
		FROM CLUB_ATTACHMENT
		WHERE REF_CLUB_NO IN
		<foreach item="item" collection="list" open="(" close=")" separator=",">
			#{item}
		</foreach>
		ORDER BY REF_CLUB_NO DESC	
	</select>
	
	<!-- 디테일페이지 조회 -->
	<select id="selectClub" parameterType="java.util.Map" resultMap="clubResultSet">
		SELECT A.*, B.*, C.REF_CLUB_NO, C.ORIGINAL_NAME, C.CHANGE_NAME, C.FILE_TYPE
		FROM CLUB A
		LEFT JOIN CLUB_TIME B
		ON A.CLUB_NO = B.REF_CLUB_NO
		LEFT JOIN CLUB_ATTACHMENT C
		ON A.CLUB_NO = C.REF_CLUB_NO
		WHERE A.STATUS='Y'
		AND A.CLUB_NO=#{cno}
		ORDER BY B.CLUB_DATE	
	</select>
	
	<!-- 독서모임 step1 수정 -->
	<update id="updateStep1" parameterType="Club">
		UPDATE CLUB
		SET HOST_NAME=#{hostName}, HOST_COMMENT=#{hostComment},
			HSTART_DATE=#{hstartDate}, HEND_DATE=#{hendDate}, HWHAT_TODO=#{hwhatTodo}
		WHERE CLUB_NO=#{clubNo} AND STATUS='Y'
	</update>
	
	<!-- 독서모임 사진 수정)update -->
	<update id="updateStep_attach" parameterType="ClubAttachment">
		UPDATE CLUB_ATTACHMENT
		SET ORIGINAL_NAME=#{originalName},
			CHANGE_NAME=#{changeName}
		WHERE REF_CLUB_NO=#{clubNo} AND FILE_TYPE=#{fileType}
	</update>

	
	<!-- <select id="selectApplyList" resultType="com.kh.bookmate.clubApply.model.vo.ClubApply">
		SELECT COUNT(*)
		FROM CLUB_APPLY
		WHERE REF_TIME_NO IN
		<foreach item="item" collection="list" open="(" close=")" separator=",">
			#{item}
		</foreach>
		ORDER BY REF_TIME_NO DESC
	</select> -->
	
</mapper>
